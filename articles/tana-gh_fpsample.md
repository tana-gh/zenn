---
title: "å†åˆ©ç”¨æ€§ã‚’é«˜ã‚ã‚‹ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ–¹æ³•ãƒ¡ãƒ¢ã€C#, Haskell, Scalaã‚’æ¯”è¼ƒã€‘"
emoji: "ğŸ’˜"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [ "é–¢æ•°å‹", "csharp", "haskell", "scala" ]
published: true
---
# ã¯ã˜ã‚ã«

æœ¬è¨˜äº‹ã§ã¯ã€**å†åˆ©ç”¨æ€§**ã«ç„¦ç‚¹ã‚’çµã£ã¦ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ–¹æ³•ã‚’è€ƒå¯Ÿã—ã¾ã™ã€‚
ä»¥ä¸‹ã®3ã¤ã®è¨€èªã§ç°¡å˜ãªãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä½œæˆã—ã€æ¯”è¼ƒã—ã¾ã™ã€‚

- C#
- Haskell
- Scala

# æœ¬è¨˜äº‹ãŒå¯¾è±¡ã¨ã™ã‚‹ã‚¢ãƒ—ãƒªã®ä»•æ§˜

1. HTTPã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ä»¥ä¸‹ã®å½¢å¼ã®JSONã‚’å–å¾—ã™ã‚‹ã€‚

```json
{
  "name": "John Smith",
  "age": 20
}
```

2. å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’æ¨™æº–å‡ºåŠ›ã«æ›¸ãå‡ºã™ã€‚

```text
name=John Smith
age=20
```

# æœ¬è¨˜äº‹ã«ãŠã‘ã‚‹å†åˆ©ç”¨æ€§

**ãƒ†ã‚¹ãƒˆã«ãŠã„ã¦ã‚¢ãƒ—ãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’å†åˆ©ç”¨ã—ã¾ã™**ã€‚
ã“ã“ã§ã€ãƒ†ã‚¹ãƒˆã¯æ¬¡ã®ã‚ˆã†ã«è¡Œãªã„ã¾ã™ã€‚

- å‰ç¯€ 1. ã«ãŠã„ã¦ã€HTTPã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰JSONã‚’å–å¾—ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¯ãƒ†ã‚¹ãƒˆã—ãªã„ã€‚
- å‰ç¯€ 2. ã«ãŠã„ã¦ã€æ¨™æº–å‡ºåŠ›ã«æ­£å¸¸ã«æ›¸ãå‡ºã›ãŸã‹ã©ã†ã‹ã¯ãƒ†ã‚¹ãƒˆã—ãªã„ã€‚
- ãƒ†ã‚¹ãƒˆã™ã‚‹ã®ã¯ã€1. ã®å‡¦ç†ãŒå‘¼ã°ã‚Œã€æ¬¡ã« 2. ã®å‡¦ç†ãŒå‘¼ã°ã‚ŒãŸã“ã¨ã®ç¢ºèªã®ã¿ã¨ã™ã‚‹ã€‚

ã¤ã¾ã‚Šã€**å®Ÿè£…ã®è©³ç´°éƒ¨åˆ†ã¯ç„¡è¦–ã—ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼ãŒæ­£ã—ã„ã“ã¨ã®ã¿ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹**ã¨ã„ã†ã“ã¨ã§ã™ã€‚

# ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚°ãƒ©ãƒ 

ä»¥ä¸‹ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

[https://github.com/tana-gh/fpsample](https://github.com/tana-gh/fpsample)

# C#

C#ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å‘è¨€èªè‰²ãŒæ¿ƒã„è¨€èªã§ã™ã€‚
å†åˆ©ç”¨æ€§ã¨ã„ã†è¦³ç‚¹ã§ã¯ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã¨DIã‚’åˆ©ç”¨ã—ã¦ã‚†ãã“ã¨ã«ãªã‚Šã¾ã™ã€‚

- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã¯ã€æ©Ÿèƒ½è©³ç´°ã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã§æŠ½è±¡åŒ–ã™ã‚‹ã€‚
- æ©Ÿèƒ½è©³ç´°ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã®å®Ÿè£…ã‚’ã‚¢ãƒ—ãƒªç‰ˆã¨ãƒ†ã‚¹ãƒˆç‰ˆã®2ç¨®é¡ç”¨æ„ã™ã‚‹ã€‚
- ã‚¢ãƒ—ãƒªã¾ãŸã¯ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œæ™‚ã€æ©Ÿèƒ½è©³ç´°ã®å®Ÿè£…ã‚¯ãƒ©ã‚¹ã‚’DIã§æ³¨å…¥ã™ã‚‹ã€‚

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ³

`fpsample-csharp/fpsample-csharp.Lib/`ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

### ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¾

```csharp:Lib/Data.cs
namespace fpsample_csharp.Lib
{
    public record Data(string Name, int Age);  // Nameã¨AgeãŒã‚ã‚‹
}
```

ã‚¢ãƒ—ãƒªã«å…¥å‡ºåŠ›ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¾ã§ã™ã€‚

### æ©Ÿèƒ½è©³ç´°ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹

```csharp:Lib/IDataReader.cs
using System.Threading.Tasks;

namespace fpsample_csharp.Lib
{
    public interface IDataReader
    {
        Task<Data> Read();  // ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
    }
}
```

```csharp:Lib/IDataWriter.cs
using System.Threading.Tasks;

namespace fpsample_csharp.Lib
{
    public interface IDataWriter
    {
        Task Write(Data data); // ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
    }
}
```

æ©Ÿèƒ½è©³ç´°ã¯`Read`ã¨`Write`ã®ã¿ã§ã™ã€‚
ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã§è¡¨ç¾ã—ã¾ã™ã€‚

### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼

```csharp:Lib/Application.cs
using System.Threading.Tasks;

namespace fpsample_csharp.Lib
{
    public class Application
    {
        private IDataReader Reader { get; }
        private IDataWriter Writer { get; }

        public Application(IDataReader reader, IDataWriter writer)  // DI
        {
            Reader = reader;
            Writer = writer;
        }

        public async Task Run()  // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æœ¬å‡¦ç†
        {
            var data = await Reader.Read();
            await Writer.Write(data);
        }
    }
}
```

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‡¦ç†ã¨ã—ã¦ã¯ã€`Read`ã‚’å‘¼ã‚“ã§ã‹ã‚‰`Write`ã‚’å‘¼ã¶ã¨ã„ã†æµã‚ŒãŒé‡è¦ã§ã‚ã‚Šã€ã“ã‚ŒãŒãƒ†ã‚¹ãƒˆå¯¾è±¡ã¨ãªã‚Šã¾ã™ã€‚

## æ©Ÿèƒ½è©³ç´°

`fpsample-csharp/fpsample-csharp.App/`ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

### ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã®å®Ÿè£…

```csharp:App/DataReader.cs
using System;
using System.Net.Http;
using System.Text.Json;
using System.Threading.Tasks;
using fpsample_csharp.Lib;

namespace fpsample_csharp.App
{
    internal class DataReader : IDataReader
    {
        private static HttpClient HttpClient { get; } = new();

        private string Url { get; }

        public DataReader(string url)
        {
            Url = url;
        }

        public async Task<Data> Read()
        {
            try
            {
                using var res = await HttpClient.GetAsync(Url);  // HTTPã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—
                var stream = await res.Content.ReadAsStreamAsync();
                return await JsonSerializer.DeserializeAsync<Data>  // JSONã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
                (
                    stream,
                    new JsonSerializerOptions() { PropertyNameCaseInsensitive = true }
                );
            }
            catch
            {
                Console.Error.WriteLine("Fail to read data.");
                throw;
            }
        }
    }
}
```

```csharp:App/DataWriter.cs
using System;
using System.Threading.Tasks;
using fpsample_csharp.Lib;

namespace fpsample_csharp.App
{
    internal class DataWriter : IDataWriter
    {
        public Task Write(Data data)
        {
            Console.WriteLine($"name={data.Name}");  // æ¨™æº–å‡ºåŠ›
            Console.WriteLine($"age={data.Age}");
            return Task.CompletedTask;
        }
    }
}
```

### ã‚¢ãƒ—ãƒªã®å®Ÿè¡Œ

```csharp:App/Program.cs
using System.Threading.Tasks;
using CommandLine;
using fpsample_csharp.Lib;

namespace fpsample_csharp.App
{
    internal class Options  // ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æƒ…å ±
    {
        [Option("url", Required = true, HelpText = "Set url for reading data.")]
        public string Url { get; set; }
    }

    internal class Program
    {
        private static Task Main(string[] args)
        {
            return Parser.Default.ParseArguments<Options>(args).WithParsedAsync<Options>(o =>
            {
                var reader = new DataReader(o.Url);
                var writer = new DataWriter();
                var app    = new Application(reader, writer);  // DI
                return app.Run();  // æœ¬å‡¦ç†å®Ÿè¡Œ
            });
        }
    }
}
```

## ãƒ†ã‚¹ãƒˆ

`fpsample-csharp/fpsample-csharp.Test/`ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

### ãƒ†ã‚¹ãƒˆã®çŠ¶æ…‹

```csharp:Test/TestState.cs
using System.Collections.Generic;

namespace fpsample_csharp.Test
{
    internal enum TestEvent
    {
        ReadCalled,  // ReadãŒå‘¼ã°ã‚ŒãŸ
        WriteCalled  // WriteãŒå‘¼ã°ã‚ŒãŸ
    }

    internal class TestState
    {
        public List<TestEvent> Events { get; } = new();  // ä¸Šè¨˜ã‚¤ãƒ™ãƒ³ãƒˆã‚’Listã«ä¿æŒ
    }
}
```

### ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã®å®Ÿè£…

```csharp:Test/TestReader.cs
using System.Threading.Tasks;
using fpsample_csharp.Lib;

namespace fpsample_csharp.Test
{
    internal class TestReader : IDataReader
    {
        private TestState State { get; set; }

        public TestReader(TestState state)
        {
            State = state;
        }

        public Task<Data> Read()
        {
            State.Events.Add(TestEvent.ReadCalled);  // ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨˜éŒ²
            return Task.FromResult(new Data("foo", 1));
        }
    }
}
```

```csharp:Test/TestWriter.cs
using System.Threading.Tasks;
using fpsample_csharp.Lib;

namespace fpsample_csharp.Test
{
    internal class TestWriter : IDataWriter
    {
        private TestState State { get; set; }

        public TestWriter(TestState state)
        {
            State = state;
        }

        public Task Write(Data data)
        {
            State.Events.Add(TestEvent.WriteCalled);  // ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨˜éŒ²
            return Task.CompletedTask;
        }
    }
}
```

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®å®Ÿè£…

```csharp:Test/UnitTest.cs
using System.Threading.Tasks;
using Xunit;
using fpsample_csharp.Lib;

namespace fpsample_csharp.Test
{
    public class UnitTest
    {
        [Fact]
        public async Task Test()
        {
            var state  = new TestState();
            var reader = new TestReader(state);
            var writer = new TestWriter(state);
            var app    = new Application(reader, writer);

            await app.Run();  // æœ¬å‡¦ç†å®Ÿè¡Œ

            Assert.Equal  // ã‚¤ãƒ™ãƒ³ãƒˆå‘¼ã³å‡ºã—ã®ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³
            (
                new TestEvent[]
                {
                    TestEvent.ReadCalled,
                    TestEvent.WriteCalled
                },
                state.Events.ToArray()
            );
        }
    }
}
```

## è€ƒå¯Ÿ

C#ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å‘è¨€èªã§ã™ãŒã€çŠ¶æ…‹ã‚’æŒãŸãªã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¤šç”¨ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€é–¢æ•°å‹çš„ãªæ›¸ãæ–¹ã‚’å®Ÿç¾ã§ãã¾ã™ã€‚
ã“ã®ã‚ˆã†ã«ã€å¤‰æ›´å¯èƒ½ãªçŠ¶æ…‹ã‚’æŒãŸãšé–¢æ•°ã ã‘ãŒå®šç¾©ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’**Functional Object**ã¨å‘¼ã¶ã“ã¨ãŒã‚ã‚‹ã‚ˆã†ã§ã™ã€‚
Functional Objectã¯ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã¨DIã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€ç°¡å˜ã«æ©Ÿèƒ½ã®åˆ‡ã‚Šæ›¿ãˆãŒå¯èƒ½ã§ã™ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€ç–çµåˆã¨å†åˆ©ç”¨æ€§ã‚’ç¢ºä¿ã—ã¦ã„ã¾ã™ã€‚

# Haskell

Haskellã¯ç´”ç²‹é–¢æ•°å‹è¨€èªã§ã™ã€‚
ç´”ç²‹é–¢æ•°ã¨å¼·åŠ›ãªå‹ã§è¡¨ç¾ã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ã®å†åˆ©ç”¨æ€§ã‚’é«˜ã‚ã‚‹ãŸã‚ã«ã€ãƒ¢ãƒŠãƒ‰å‹ã‚¯ãƒ©ã‚¹ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã¯ã€å‹ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã—ã€ãã®å‹ã®ä¸Šã§å‡¦ç†ã‚’è¨˜è¿°ã™ã‚‹ã€‚
- æ©Ÿèƒ½è©³ç´°å‹ã‚¯ãƒ©ã‚¹ã®å®Ÿè£…ã‚’ã‚¢ãƒ—ãƒªç‰ˆã¨ãƒ†ã‚¹ãƒˆç‰ˆã®2ç¨®é¡ç”¨æ„ã™ã‚‹ã€‚
- ã‚¢ãƒ—ãƒªã¾ãŸã¯ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œæ™‚ã€å‹ã‚¯ãƒ©ã‚¹ã‚’å®Ÿè£…ã—ãŸå‹ã‚’ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦ç½®ãã€‚

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ³

`fpsample-haskell/src/FpsampleHaskell/`ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

### ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¾

```haskell:Data.hs
{-# LANGUAGE DeriveGeneric #-}

module FpsampleHaskell.Data
    ( Data(..)
    ) where

import GHC.Generics
    ( Generic
    )

data Data = Data
    { name :: String
    , age  :: Int
    } deriving Generic  -- Aesonã®ãŸã‚ã«Genericã¨ã™ã‚‹
```

ã‚¢ãƒ—ãƒªã«å…¥å‡ºåŠ›ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¾ã§ã™ã€‚

### æ©Ÿèƒ½è©³ç´°å‹ã‚¯ãƒ©ã‚¹

```haskell:Monad.hs
module FpsampleHaskell.Monad
    ( MonadDataReader(readData)
    , MonadDataWriter(writeData)
    , MonadApp
    ) where

import FpsampleHaskell.Data
    ( Data
    )

class Monad m => MonadDataReader m where
    readData :: m Data  -- ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°

class Monad m => MonadDataWriter m where
    writeData :: Data -> m ()  -- ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã™ã‚‹é–¢æ•°

class (MonadDataReader m, MonadDataWriter m) => MonadApp m  -- ä¸Šè¨˜ã‚’ã¾ã¨ã‚ãŸã‚‚ã®
```

å‹ã‚¯ãƒ©ã‚¹ã¯ãƒ¢ãƒŠãƒ‰ã¨ã—ã¦å®šç¾©ã—ã¾ã™ã€‚

### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼

```haskell:App.hs
module FpsampleHaskell.App
    ( app
    ) where

import FpsampleHaskell.Monad
    ( MonadApp
    , MonadDataReader(..)
    , MonadDataWriter(..)
    )

app :: (MonadApp m) => m ()
app = readData >>= writeData  -- å‡¦ç†é †ã‚’å®šç¾©
```

`MonadApp`ã¯ãƒ¢ãƒŠãƒ‰ãªã®ã§ã€æ‰‹ç¶šãçš„ã«é †åºç«‹ã¦ã¦å‡¦ç†ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

## æ©Ÿèƒ½è©³ç´°

`fpsample-haskell/app/`ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

### ã‚¢ãƒ—ãƒªã®å‹å®šç¾©ã¨å®Ÿè¡Œ

```haskell:Main.hs
{-# LANGUAGE FlexibleInstances #-}
{-# LANGUAGE GeneralisedNewtypeDeriving #-}

module Main where

import Control.Monad.IO.Class
    ( MonadIO(..)
    )
import Control.Monad.Reader
    ( MonadReader
    , MonadTrans
    , ReaderT(..)
    , asks
    , runReaderT
    )
import Data.Aeson
    ( FromJSON
    )
import Network.HTTP.Simple
    ( Response
    , parseRequest
    , getResponseBody
    , httpJSON
    )
import Options.Applicative
    ( (<**>)
    , execParser
    , fullDesc
    , header
    , help
    , helper 
    , info
    , long
    , progDesc
    , strOption
    )
import Options.Applicative.Types
    ( Parser
    )
import FpsampleHaskell.App
    ( app
    )
import FpsampleHaskell.Data
    ( Data(..)
    )
import FpsampleHaskell.Monad
    ( MonadApp
    , MonadDataReader(..)
    , MonadDataWriter(..)
    )

newtype App r m a = App  -- MonadAppã®å®Ÿä½“
    { runApp :: ReaderT r m a
    } deriving
    ( Functor
    , Applicative
    , Monad
    , MonadTrans
    , MonadReader r
    , MonadIO
    )

newtype Config = Config  -- ã‚¢ãƒ—ãƒªã®è¨­å®š
    { url :: String
    }

instance FromJSON Data  -- Dataã«FromJSONã‚’å®Ÿè£…

instance MonadIO m => MonadDataReader (App Config m) where
    readData = do
        url' <- asks url
        req  <- liftIO $ parseRequest url'
        res  <- liftIO $ httpJSON req  -- HTTPã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ã€åŒæ™‚ã«JSONã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
        return $ getResponseBody res
        
instance MonadIO m => MonadDataWriter (App Config m) where
    writeData data' =
        liftIO $ do
            putStrLn $ "name=" ++ name data'  -- æ¨™æº–å‡ºåŠ›
            putStrLn $ "age=" ++ show (age data')

instance MonadIO m => MonadApp (App Config m)

newtype Options = Options  -- ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æƒ…å ±
    { urlOption :: String
    }

parser :: Parser Options
parser = Options <$> strOption (long "url" <> help "Set url for reading data.")

main :: IO ()
main = do
    options <- execParser $ info (parser <**> helper) fullDesc
    let config = Config $ urlOption options
    (`runReaderT` config) $ runApp app  -- æœ¬å‡¦ç†å®Ÿè¡Œ
```

## ãƒ†ã‚¹ãƒˆ

`fpsample-haskell/test/`ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

### ãƒ†ã‚¹ãƒˆã®å‹å®šç¾©ã¨ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®å®Ÿè£…

```haskell:Test.hs
{-# LANGUAGE FlexibleInstances #-}
{-# LANGUAGE GeneralisedNewtypeDeriving #-}

module Main where

import Control.Monad.State
    ( MonadIO
    , MonadState
    , MonadTrans
    , StateT(..)
    , execStateT
    , modify
    )
import Test.Hspec
    ( Spec
    , hspec
    , describe
    , it
    , shouldBe
    )
import FpsampleHaskell.App
    ( app
    )
import FpsampleHaskell.Data
    ( Data(..)
    )
import FpsampleHaskell.Monad
    ( MonadApp
    , MonadDataReader(..)
    , MonadDataWriter(..)
    )

newtype TestApp s m a = TestApp  -- MonadAppã®å®Ÿä½“ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
    { runApp :: StateT s m a
    } deriving
    ( Functor
    , Applicative
    , Monad
    , MonadTrans
    , MonadState s
    , MonadIO
    )

data TestEvent
    = ReadDataCalled   -- readDataãŒå‘¼ã°ã‚ŒãŸ
    | WriteDataCalled  -- writeDataãŒå‘¼ã°ã‚ŒãŸ
    deriving (Eq, Show)

newtype TestState = TestState [TestEvent]  -- ä¸Šè¨˜ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¿æŒã™ã‚‹ãŸã‚ã®å‹

instance Monad m => MonadDataReader (TestApp TestState m) where
    readData = do
        modify $ \(TestState events) -> TestState (ReadDataCalled : events)  -- ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨˜éŒ²
        return Data { name = "foo", age = 1 }
        
instance Monad m => MonadDataWriter (TestApp TestState m) where
    writeData _ = modify $ \(TestState events) -> TestState (WriteDataCalled : events)  -- ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨˜éŒ²

instance Monad m => MonadApp (TestApp TestState m)

spec :: Spec
spec =
    describe "app" $
        it "readData and writeData are called correctly" $ do
            (TestState events) <- (`execStateT` TestState []) $ runApp app  -- æœ¬å‡¦ç†å®Ÿè¡Œ
            events `shouldBe` [ WriteDataCalled, ReadDataCalled ]  -- ã‚¤ãƒ™ãƒ³ãƒˆå‘¼ã³å‡ºã—ã®ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³

main :: IO ()
main = hspec spec
```

## è€ƒå¯Ÿ

Haskellã¯å‹ãŒéå¸¸ã«å¼·åŠ›ã§ã€å‰¯ä½œç”¨ã‚’å‹ã®åŠ›ã§åˆ†é›¢ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ãã‚Œã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ãƒ¢ãƒŠãƒ‰ã‚’å¤šç”¨ã™ã‚‹ã“ã¨ã«ãªã‚‹ãŸã‚ã€å†åˆ©ç”¨æ€§ã®ç¢ºä¿ã«ã¯ãƒ¢ãƒŠãƒ‰å‹ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã®ãŒ1ã¤ã®æ–¹ç­–ã¨ãªã‚Šã¾ã™ã€‚

# Scala

Scalaã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å‘ã¨é–¢æ•°å‹ã‚’çµ¶å¦™ãªãƒãƒ©ãƒ³ã‚¹ã§èåˆã•ã›ã¦ã„ã‚‹ã‚ˆã†ãªè¨€èªã§ã™ã€‚
å‹æ©Ÿèƒ½ãŒå¼·åŠ›ã§ã‚ã‚‹ãŸã‚ã€Haskellã®ã‚ˆã†ã«ãƒ¢ãƒŠãƒ‰ã‚’ä½¿ç”¨ã—ã¦è¨˜è¿°ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€ã“ã“ã§ã¯ã‚‚ã†å°‘ã—ã‚½ãƒ•ãƒˆãªæ–¹æ³•ã‚’è©¦ã—ã¾ã™ã€‚
Scalaã¯åŸºæœ¬çš„ã«ã¯æ‰‹ç¶šãå‹ã§ã™ã®ã§ã€å‰¯ä½œç”¨ã«é–¢ã—ã¦ã¯å‹ã‚¯ãƒ©ã‚¹ã«ç››ã‚Šè¾¼ã¾ãªã„ã“ã¨ã¨ã—ã¾ã™ã€‚
ãã®ãŸã‚ã€å†åˆ©ç”¨æ€§ã®ç¢ºä¿ã«ãƒ¢ãƒŠãƒ‰ã¯åˆ©ç”¨ã—ã¾ã›ã‚“ã€‚

- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã¯ã€å‹ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã—ã€ãã®å‹ã®ä¸Šã§å‡¦ç†ã‚’è¨˜è¿°ã™ã‚‹ã€‚
- æ©Ÿèƒ½è©³ç´°å‹ã‚¯ãƒ©ã‚¹ã®å®Ÿè£…ã‚’ã‚¢ãƒ—ãƒªç‰ˆã¨ãƒ†ã‚¹ãƒˆç‰ˆã®2ç¨®é¡ç”¨æ„ã™ã‚‹ã€‚
- ã‚¢ãƒ—ãƒªã¾ãŸã¯ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œæ™‚ã€`given`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”¨æ„ã™ã‚‹ã€‚

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ³

`fpsample-scala/lib/src/main/scala/`ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

### ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¾

```scala:Data.scala
package fpsample_scala.lib

case class Data(name: String, age: Int)  // nameã¨ageãŒã‚ã‚‹
```

ã‚¢ãƒ—ãƒªã«å…¥å‡ºåŠ›ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¾ã§ã™ã€‚

### æ©Ÿèƒ½è©³ç´°å‹ã‚¯ãƒ©ã‚¹

```scala:Traits.scala
package fpsample_scala.lib

import scala.concurrent.{
  ExecutionContext,
  Future
}

trait DataReader[App]:
  extension (app: App)
    def read(using ExecutionContext): Future[Data]  // ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°

trait DataWriter[App]:
  extension (app: App)
    def write(data: Data)(using ExecutionContext): Future[Unit]  // ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã™ã‚‹é–¢æ•°
```

ã“ã“ã§ã¯å‹ã‚¯ãƒ©ã‚¹ã¯ãƒ¢ãƒŠãƒ‰ã§ã¯ãªããŸã ã®åˆ¶ç´„ã§ã™ã€‚

### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼

```scala:App.scala
package fpsample_scala.lib

import scala.concurrent.{
  ExecutionContext,
  Future
}

def runApp[App](app: App)(using DataReader[App], DataWriter[App], ExecutionContext): Future[Unit] =  // ã‚¢ãƒ—ãƒªã®æœ¬å‡¦ç†
  for
    data <- app.read
    ()   <- app.write(data)
  yield ()
```

`Future`ãŒã‚ã‚‹ã®ã§ãƒ¢ãƒŠãƒ‰çš„ã«å‡¦ç†ã—ã¦ã„ã¾ã™ãŒã€`App`å‹è‡ªä½“ã¯ãƒ¢ãƒŠãƒ‰ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

## æ©Ÿèƒ½è©³ç´°

`fpsample-scala/app/src/main/scala/`ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

### ã‚¢ãƒ—ãƒªã®å‹å®šç¾©

```scala:Impl.scala
package fpsample_scala.app

import scala.compat.java8.{
  FutureConverters
}
import scala.concurrent.{
  ExecutionContext,
  Future
}
import java.net.{
  URI
}
import java.net.http.{
  HttpClient,
  HttpResponse,
  HttpRequest
}
import io.circe.generic.auto.*
import io.circe.parser.{
  decode
}
import fpsample_scala.lib.{
  Data,
  DataReader,
  DataWriter
}

case class App(url: String)  // ã‚¢ãƒ—ãƒªå‹

given DataReader[App] with
  extension (app: App)
    def read(using ExecutionContext): Future[Data] =
      val client = HttpClient.newHttpClient()
      val req    = HttpRequest
        .newBuilder
        .uri(URI.create(app.url))
        .build
      
      for
        res <- FutureConverters.toScala(
          client
            .sendAsync(req, HttpResponse.BodyHandlers.ofString())  // HTTPã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—
        )
      yield
        decode[Data](res.body) match  // JSONã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
          case Left(e) =>
            Console.err.println(e)
            throw IllegalStateException()
          case Right(data) => data

given DataWriter[App] with
  extension (app: App)
    def write(data: Data)(using ExecutionContext): Future[Unit] =
      println(s"name=${data.name}")  // æ¨™æº–å‡ºåŠ›
      println(s"age=${data.age}")
      Future.successful(())
```

Scalaã§ã¯ã€å‹ã‚¯ãƒ©ã‚¹ã®å®Ÿè£…ã‚’`given`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦å®šç¾©ã—ã¦ãŠãã¾ã™ã€‚

### ã‚¢ãƒ—ãƒªã®å®Ÿè¡Œ

```scala:Main.scala
package fpsample_scala.app

import scala.concurrent.{
  Await
}
import scala.concurrent.duration.*
import scala.concurrent.ExecutionContext.Implicits.global
import scala.language.{
  postfixOps
}
import scopt.{
  OParser
}
import fpsample_scala.lib.{
  runApp
}

case class Options(url: String = "")  // ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æƒ…å ±

@main
def main(args: String*): Unit = 
  val builder = OParser.builder[Options]
  val parser  = OParser.sequence(
    builder.opt[String]("url")
      .required()
      .action((x, opt) => opt.copy(url = x))
      .text("Set url for reading data.")
  )

  OParser.parse(parser, args, Options()) match
    case Some(options) =>
      Await.ready(runApp(App(options.url)), Duration.Inf)  // æœ¬å‡¦ç†å®Ÿè¡Œ
    case _ => ()
```

## ãƒ†ã‚¹ãƒˆ

`fpsample-scala/app/src/test/scala/`ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

### ãƒ†ã‚¹ãƒˆã®å‹å®šç¾©ã¨ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®å®Ÿè£…

```scala:Test.scala
import scala.collection.mutable.ListBuffer
import scala.concurrent.{
  Await,
  ExecutionContext,
  Future
}
import scala.concurrent.duration.*
import scala.concurrent.ExecutionContext.Implicits.global
import scala.language.{
  postfixOps
}
import org.scalatest.funsuite.{
  AnyFunSuite
}
import fpsample_scala.lib.{
  Data,
  DataReader,
  DataWriter,
  runApp
}


enum TestEvent:
  case ReadCalled   // readãŒå‘¼ã°ã‚ŒãŸ
  case WriteCalled  // writeãŒå‘¼ã°ã‚ŒãŸ

import TestEvent.*

case class TestState(
  events: ListBuffer[TestEvent] = ListBuffer[TestEvent]()  // ä¸Šè¨˜ã‚¤ãƒ™ãƒ³ãƒˆã‚’Listã«ä¿æŒ
)

case class TestApp(state: TestState)  // ã‚¢ãƒ—ãƒªå‹ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰

given DataReader[TestApp] with
  extension (app: TestApp)
    def read(using ExecutionContext): Future[Data] =
      app.state.events += ReadCalled  // ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨˜éŒ²
      Future.successful(Data("foo", 1))

given DataWriter[TestApp] with
  extension (app: TestApp)
    def write(data: Data)(using ExecutionContext): Future[Unit] =
      app.state.events += WriteCalled  // ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨˜éŒ²
      Future.successful(())

class SetSuite extends AnyFunSuite:
  test("readData and writeData are called correctly") {
    val state = TestState()
    Await.ready(runApp(TestApp(state)), Duration.Inf)  // æœ¬å‡¦ç†å®Ÿè¡Œ
    assertResult(List(ReadCalled, WriteCalled))(state.events.toList)  // ã‚¤ãƒ™ãƒ³ãƒˆå‘¼ã³å‡ºã—ã®ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³
  }
```

## è€ƒå¯Ÿ

Scalaã«ã¯ cats ã‚„ zio ãªã©ã®å¼·åŠ›ãªå‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚ã‚Šã¾ã™ãŒã€ãã‚Œã‚‰ã‚’ä½¿ã‚ãšã«ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã™ã‚‹ã¨ã“ã†ãªã‚Šã¾ã—ãŸã€‚
å‹æƒ…å ±ã§å‰¯ä½œç”¨ã‚’åˆ†é›¢ã—ã¦ã¯ã„ãªã„ã®ã§ã™ãŒã€å†åˆ©ç”¨æ€§ã‚’é«˜ã‚ã‚‹1ã¤ã®å‹•æ©Ÿã¨ã—ã¦å‰¯ä½œç”¨ã®åˆ†é›¢ã¯é‡è¦ã§ã‚ã‚‹ãŸã‚ã€å‹ã®å¼·ã•ã«é–¢ã‚ã‚‰ãšã‚³ãƒ¼ãƒ€ãƒ¼ã¯å‰¯ä½œç”¨ã¯åˆ†é›¢ã™ã‚‹ã¯ãšã§ã™ã€‚
ã‚‚ã¡ã‚ã‚“ã€å‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã™ã‚Œã°å‰¯ä½œç”¨ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ç‚¹ã§æ¤œè¨¼ã§ãã¾ã™ãŒã€æœ¬è¨˜äº‹ã§ã¯ãã“ã¾ã§ã‚„ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
ã“ã“ã§ç¤ºã—ãŸã‚³ãƒ¼ãƒ‰ã§ã¯ã‚ã¾ã‚Šãƒ¡ãƒªãƒƒãƒˆãŒæ„Ÿã˜ã¾ã›ã‚“ãŒã€Scalaã¯æ‰‹ç¶šãå‹ã®è¨˜è¿°ãŒã§ãã‚‹ãŸã‚ã€ã“ã®ã‚ˆã†ãªã‚„ã‚Šæ–¹ã§ã‚‚æ©æµãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚

# ã¾ã¨ã‚

3ã¤ã®è¨€èªã«ã¤ã„ã¦å†åˆ©ç”¨æ€§ã‚’æ„è­˜ã—ãŸã‚³ãƒ¼ãƒ‰ä¾‹ã‚’ç¤ºã—ã¾ã—ãŸã€‚
ã“ã‚Œä»¥ä¸Šç„¡ã„ãã‚‰ã„å˜ç´”ãªä¾‹ã§ã—ãŸãŒã€ã“ã®ã‚„ã‚Šæ–¹ã¯å®Ÿè·µã§ã‚‚å½¹ã«ç«‹ã¤ã¨æ€ã„ã¾ã™ã€‚
æœ¬è¨˜äº‹ã§ç¤ºã—ãŸã‚„ã‚Šæ–¹ä»¥å¤–ã«ã‚‚æ–¹æ³•ã¯ã‚ã‚Šã¾ã™ãŒã€ã‚·ãƒ³ãƒ—ãƒ«ã•ã‚’é‡è¦–ã—ã¦ã“ã®ã‚ˆã†ãªå½¢ã«ãªã‚Šã¾ã—ãŸã€‚
éå¸¸ã«é•·ããªã‚Šã¾ã—ãŸãŒã€ã”è¦§ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚
